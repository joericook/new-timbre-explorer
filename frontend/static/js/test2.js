// Questions in the following JSON format:
//
//let questionsTest2 = [
//    {
//        "id":"",
//        "question":"",
//        "soundSource": "",
//        "answer":""
//    },...  
//
// Obfuscated to protect integrity of the study

const _0xd6dd=['static/TE_sounds/task2.2_sounds/2.2_12.wav','2-2_9','2-2_10','2-2_4','static/TE_sounds/task2.2_sounds/2.2_6.wav','static/TE_sounds/task2.2_sounds/2.2_22.wav','882982DQVqnS','2-2_8','449573rGTAge','4QduvrA','static/TE_sounds/task2.2_sounds/2.2_9.wav','34SXpPRT','static/TE_sounds/task2.2_sounds/2.2_11.wav','static/TE_sounds/task2.2_sounds/2.2_19.wav','static/TE_sounds/task2.2_sounds/2.2_18.wav','static/TE_sounds/task2.2_sounds/2.2_10.wav','2-2_16','2-2_14','2-2_1','2-2_11','33201icYFdP','2eNSqFm','2-2_7','1Buadnh','2-2_17','2-2_18','30238kSgUvG','static/TE_sounds/task2.2_sounds/2.2_4.wav','2-2_15','2-2_21','2-2_3','static/TE_sounds/task2.2_sounds/2.2_3.wav','static/TE_sounds/task2.2_sounds/2.2_1.wav','13124AcUNnD','189670agglef','static/TE_sounds/task2.2_sounds/2.2_23.wav','2-2_13','21WZWYmU','static/TE_sounds/task2.2_sounds/2.2_14.wav','static/TE_sounds/task2.2_sounds/2.2_7.wav','static/TE_sounds/task2.2_sounds/2.2_20.wav','2-2_23','static/TE_sounds/task2.2_sounds/2.2_8.wav','Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','2-2_19','761859DcyTVn'];function _0x2eee(_0x5c2096,_0x53f8ef){return _0x2eee=function(_0xd6dd69,_0x2eee00){_0xd6dd69=_0xd6dd69-0x194;let _0x8955ed=_0xd6dd[_0xd6dd69];return _0x8955ed;},_0x2eee(_0x5c2096,_0x53f8ef);}const _0x1da269=_0x2eee;(function(_0x300b28,_0x5dbcac){const _0xddcae4=_0x2eee;while(!![]){try{const _0x124de9=parseInt(_0xddcae4(0x1bf))*parseInt(_0xddcae4(0x1a9))+parseInt(_0xddcae4(0x1ac))*parseInt(_0xddcae4(0x19b))+-parseInt(_0xddcae4(0x1b7))*parseInt(_0xddcae4(0x1a6))+-parseInt(_0xddcae4(0x1b4))+-parseInt(_0xddcae4(0x19a))*-parseInt(_0xddcae4(0x1a7))+parseInt(_0xddcae4(0x1b3))*parseInt(_0xddcae4(0x19d))+-parseInt(_0xddcae4(0x198));if(_0x124de9===_0x5dbcac)break;else _0x300b28['push'](_0x300b28['shift']());}catch(_0x5205d8){_0x300b28['push'](_0x300b28['shift']());}}}(_0xd6dd,0x6fe3c));let questionsTest2=[{'id':_0x1da269(0x1a4),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x1b2),'answer':'a'},{'id':'2-2_2','question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':'static/TE_sounds/task2.2_sounds/2.2_2.wav','answer':'b'},{'id':_0x1da269(0x1b0),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x1b1),'answer':'c'},{'id':_0x1da269(0x195),'question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x1ad),'answer':'d'},{'id':'2-2_5','question':_0x1da269(0x1bd),'soundSource':'static/TE_sounds/task2.2_sounds/2.2_5.wav','answer':'e'},{'id':'2-2_6','question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x196),'answer':'f'},{'id':_0x1da269(0x1a8),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x1b9),'answer':'g'},{'id':_0x1da269(0x199),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x1bc),'answer':'h'},{'id':_0x1da269(0x1c1),'question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x19c),'answer':'i'},{'id':_0x1da269(0x194),'question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x1a1),'answer':'j'},{'id':_0x1da269(0x1a5),'question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x19e),'answer':'k'},{'id':'2-2_12','question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x1c0),'answer':'l'},{'id':_0x1da269(0x1b6),'question':_0x1da269(0x1bd),'soundSource':'static/TE_sounds/task2.2_sounds/2.2_13.wav','answer':'m'},{'id':_0x1da269(0x1a3),'question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x1b8),'answer':'n'},{'id':_0x1da269(0x1ae),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':'static/TE_sounds/task2.2_sounds/2.2_15.wav','answer':'o'},{'id':_0x1da269(0x1a2),'question':_0x1da269(0x1bd),'soundSource':'static/TE_sounds/task2.2_sounds/2.2_16.wav','answer':'p'},{'id':_0x1da269(0x1aa),'question':_0x1da269(0x1bd),'soundSource':'static/TE_sounds/task2.2_sounds/2.2_17.wav','answer':'q'},{'id':_0x1da269(0x1ab),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x1a0),'answer':'r'},{'id':_0x1da269(0x1be),'question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x19f),'answer':'s'},{'id':'2-2_20','question':_0x1da269(0x1bd),'soundSource':_0x1da269(0x1ba),'answer':'t'},{'id':_0x1da269(0x1af),'question':_0x1da269(0x1bd),'soundSource':'static/TE_sounds/task2.2_sounds/2.2_21.wav','answer':'u'},{'id':'2-2_22','question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x197),'answer':'v'},{'id':_0x1da269(0x1bb),'question':'Listen\x20to\x20the\x20sound\x20and\x20click\x20the\x20tile\x20with\x20the\x20matching\x20properties.','soundSource':_0x1da269(0x1b5),'answer':'w'},{'id':'2-2_24','question':_0x1da269(0x1bd),'soundSource':'static/TE_sounds/task2.2_sounds/2.2_24.wav','answer':'x'}];

// Declare variables
const questionTest2 = document.getElementById("questionTest2");
const answers = Array.from(document.getElementsByClassName("bingo-answer-text"));
const questionCounterTextTest2 = document.getElementById("counterTextTest2");
const scoreTextTest2 = document.getElementById("scoreTest2");

let questionCounterTest2;
let scoreTest2;
let scoreToAddTest2;
const MAX_QUESTIONS_TEST2 = 10;
// THIS doesn't need to be declared as long as train.js is run first
 let acceptingAnswers;

startTest2 = () => {
    questionCounterTest2 = 0;
    scoreTest2 = 0;
    //console.log("questions: ", questionsTest2);
    acceptingAnswers = true;

    test2Start = Date.now();

    availableQuestions = getRandomQuestionsTest2(questionsTest2, MAX_QUESTIONS_TEST2);
    //console.log("randomised order: ", availableQuestions);

    getNewQuestionTest2();
}

// Shuffles available questions into a random order
const getRandomQuestionsTest2 = (arr, n) => {
    let len = arr.length;
    if (n > len) {
        throw new RangeError(
            "getRandomQuestions: more elements taken than available"
        );
    }

    // Shuffles the order of the questions
    const shuffled = [...arr].sort(() => 0.5 - Math.random());

    // Return randomised array of questions
    return (selected = shuffled.slice(0, n));
}

const getNewQuestionTest2 = () => {
    // End when all questions have been shown
    if (availableQuestions.length === 0) {
        //console.log("No more questions")
        // Append to data object
        // For test 2: Overall test score; Time elapsed since start of test (s);
        testing2Data = Object.assign({ "overallTest2": {"scoreTest2": scoreTest2, "timeTest2": ((Date.now() - test2Start) / 1000)} }, testing2Data);
        testing2Data = {"testing2": testing2Data};
        //console.log(testing2Data);

        displayModalTest2();
        return;
    }

    // Increment question counter and update display
    questionCounterTest2++;
    questionCounterTextTest2.innerText = questionCounterTest2 + "/" + MAX_QUESTIONS_TEST2;

    // Update display with current question
    currentQuestion = availableQuestions[0];
    //console.log("current question: ", currentQuestion);
    
    //console.log(currentQuestion);
    questionTest2.innerText = currentQuestion.question;

    // Update with correct audio file for each question
    document.getElementById("soundTest2").setAttribute("src", currentQuestion.soundSource);

    // 3 points for first attempt, 2 for second, 1 for third
    scoreToAddTest2 = 3;

    // Array to hold users answers for each question
    let userAnswers = [];

    // Get time of question start 
    questionStart = Date.now();

    // Add event listeners for answer selection
    answers.forEach((answer) => {
        answer.addEventListener("click", (e) => {
            // If not accepting answers, return
            if(!acceptingAnswers) {
                //console.log("not accepting answers");
                return;
            }
            // Set acceptingAnswers to false to only allow single answer
            acceptingAnswers = false

            // This ensures that answers are still recognised if a <mark> element is clicked
            let clickedAnswer;
            if (e.target.nodeName == "MARK") {
                clickedAnswer = e.target.parentElement;
            }
            else {
                clickedAnswer = e.target;
            }
            
            const answerLetter = clickedAnswer.dataset["answer"]
            //console.log(answerLetter);
            // Append clicked answer to 'userAnswers'
            userAnswers.push(answerLetter);

            // Update clicked div with colour for correct or incorrect answer
            let classToApply = "incorrect";

            // If correct answer is clicked, increment score and set class to correct
            if (answerLetter === currentQuestion.answer) {
                //console.log("correct answer");
                scoreTest2 += scoreToAddTest2;
                scoreTextTest2.innerText = scoreTest2;
                classToApply = "correct";
            }
            // If incorrect answer is clicked for first and second attempts, decrement scoreToAdd, give negative feedback, then return
            else if (scoreToAddTest2 > 1) {
                scoreToAddTest2 -= 1;
                clickedAnswer.parentElement.classList.add(classToApply);
                //console.log("incorrect answer");
                setTimeout(() => {
                    clickedAnswer.parentElement.classList.remove(classToApply);
                    acceptingAnswers = true;
                }, 1000);
                return;
            }
            else {
                // If incorrect answer is clicked on third attempt, lower added score to 0, get next question
                scoreToAddTest2 -= 1;   
            }

            // Apply the appropriate class
            clickedAnswer.parentElement.classList.add(classToApply);

            // After time period, remove the correct/incorrect class and get the next question
            setTimeout(() => {
                // If answer was correct, leave the answer highlighted and lower opacity
                if (classToApply === "incorrect") {
                    clickedAnswer.parentElement.classList.remove(classToApply);
                }
                else if (classToApply === "correct") {
                    clickedAnswer.parentElement.classList.remove(classToApply);
                    clickedAnswer.parentElement.classList.add("bingo-locked");
                }

                // Append question data to object
                // Question no.: Correct answer; Users Answers; Users score for the question; 
                testing2Data = Object.assign({ [currentQuestion.id]: {"correctAnswer": currentQuestion.answer, "userAnswers": userAnswers, 
                                                "questionScore": scoreToAddTest2, "time": ((Date.now() - questionStart) / 1000)} }, testing2Data);
                //console.log(testing2Data);
                // Empty 'userAnswers' array before getting next question
                userAnswers = [];

                getNewQuestionTest2();
                acceptingAnswers = true;
            }, 1000);
        });
    });
    availableQuestions.shift();
};

hideModal = () => {
    const modal = document.getElementById("taskCompleteModal");
    modal.style.display = "none"
}

//Shows task complete modal 
displayModalTest2 = () => {
    const modal = document.getElementById("taskCompleteModal");
    // Display test score
    const modalTitle = document.getElementById("modal-title");
    modalTitle.innerHTML = /*html*/`
                            Task Complete! &emsp;&emsp;&emsp;&emsp;&emsp; You scored: ${scoreTest2} / 30
                        `
    const modalBody = document.getElementById("modal-body");
    modalBody.innerHTML = /*html*/`
                            <p>
                                Click next when you are ready to continue... <br>
                            </p>
                            <div class="nextButton">
                                <a class="nextText" onclick="hideModal()" href="/feedback2" data-link>Next</a>
                            </div>
                        `
    modal.style.display = "block"
}

startTest2();

