// Questions in the following JSON format:
//
//let descriptionsTrain1 = [
//    {
//        "id":"",
//        "description":"",
//        "soundASource": "",
//        "soundBSource": "",
//        "spectrumValue": "",
//        "brightnessValue": "",
//        "articulationValue": "",
//        "envelopeValue": "",
//        "sliderToMove": "",
//        "correctValue": ""
//    },...
//
// Obfuscated to protect integrity of the study

const _0x1995=['Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20envelope\x20dimension.\x20Sound\x20B\x20has\x20a\x20higher\x20envelope\x20value.','224','static/TE_sounds/task1.1_sounds/1.1_6a.wav','enveSlider','static/TE_sounds/task1.1_sounds/1.1_8b.wav','static/TE_sounds/task1.1_sounds/1.1_7b.wav','1-1_8','static/TE_sounds/task1.1_sounds/1.1_10a.wav','static/TE_sounds/task1.1_sounds/1.1_13a.wav','118','1-1_16','static/TE_sounds/task1.1_sounds/1.1_4a.wav','static/TE_sounds/task1.1_sounds/1.1_16a.wav','188','191','200','225','static/TE_sounds/task1.1_sounds/1.1_3b.wav','1-1_9','static/TE_sounds/task1.1_sounds/1.1_12a.wav','125','23DNfHFl','static/TE_sounds/task1.1_sounds/1.1_11a.wav','1-1_12','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Brightness\x20dimension.\x20Sound\x20B\x20has\x20a\x20higher\x20Brightness\x20value.','specSlider','206','208','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20envelope\x20dimension.\x20Sound\x20B\x20has\x20a\x20lower\x20envelope\x20value.','56IAcYVH','185','106','241','static/TE_sounds/task1.1_sounds/1.1_16b.wav','static/TE_sounds/task1.1_sounds/1.1_9a.wav','1-1_4','1115986AVPzTR','226','static/TE_sounds/task1.1_sounds/1.1_6b.wav','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Articulation\x20dimension.\x20Sound\x20B\x20has\x20a\x20higher\x20Articulation\x20value.','100','static/TE_sounds/task1.1_sounds/1.1_10b.wav','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Brightness\x20dimension.\x20Sound\x20B\x20has\x20a\x20lower\x20Brightness\x20value.','1-1_13','1-1_5','250','static/TE_sounds/task1.1_sounds/1.1_5b.wav','static/TE_sounds/task1.1_sounds/1.1_7a.wav','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Spectrum\x20dimension.\x20Sound\x20B\x20has\x20a\x20lower\x20Spectrum\x20value.','110','1-1_7','artiSlider','138','static/TE_sounds/task1.1_sounds/1.1_5a.wav','215','1451797rmbJGs','255','static/TE_sounds/task1.1_sounds/1.1_14a.wav','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Articulation\x20dimension.\x20Sound\x20B\x20has\x20a\x20lower\x20Articulation\x20value.','150','35941QnnCMl','108','1-1_6','29328adZSWo','static/TE_sounds/task1.1_sounds/1.1_2b.wav','5996ZbJqAd','175','1-1_11','160','72324RphqhE','128','122','static/TE_sounds/task1.1_sounds/1.1_1a.wav','803214ecjdOr','static/TE_sounds/task1.1_sounds/1.1_9b.wav','180','brigSlider','Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Spectrum\x20dimension.\x20Sound\x20B\x20has\x20a\x20higher\x20Spectrum\x20value.','1-1_15','1-1_10','static/TE_sounds/task1.1_sounds/1.1_11b.wav','static/TE_sounds/task1.1_sounds/1.1_1b.wav','static/TE_sounds/task1.1_sounds/1.1_4b.wav','static/TE_sounds/task1.1_sounds/1.1_12b.wav','static/TE_sounds/task1.1_sounds/1.1_13b.wav','static/TE_sounds/task1.1_sounds/1.1_3a.wav','static/TE_sounds/task1.1_sounds/1.1_15a.wav'];const _0x2a15b8=_0x4d65;(function(_0xcac56,_0x302235){const _0x25b9cf=_0x4d65;while(!![]){try{const _0x5603cf=parseInt(_0x25b9cf(0x1bf))+-parseInt(_0x25b9cf(0x1b5))+-parseInt(_0x25b9cf(0x1bb))+-parseInt(_0x25b9cf(0x1ad))+parseInt(_0x25b9cf(0x1f1))+-parseInt(_0x25b9cf(0x1e2))*-parseInt(_0x25b9cf(0x1b2))+parseInt(_0x25b9cf(0x1b7))*-parseInt(_0x25b9cf(0x1ea));if(_0x5603cf===_0x302235)break;else _0xcac56['push'](_0xcac56['shift']());}catch(_0x1cf00e){_0xcac56['push'](_0xcac56['shift']());}}}(_0x1995,0xd122a));function _0x4d65(_0x3fa06a,_0x3bc2a9){return _0x4d65=function(_0x1995b8,_0x4d65e2){_0x1995b8=_0x1995b8-0x1a6;let _0x1c392d=_0x1995[_0x1995b8];return _0x1c392d;},_0x4d65(_0x3fa06a,_0x3bc2a9);}let descriptionsTrain1=[{'id':'1-1_1','description':_0x2a15b8(0x1c3),'soundASource':_0x2a15b8(0x1be),'soundBSource':_0x2a15b8(0x1c7),'spectrumValue':'10','brightnessValue':_0x2a15b8(0x1e8),'articulationValue':'4','envelopeValue':_0x2a15b8(0x1eb),'sliderToMove':_0x2a15b8(0x1e6),'correctValue':_0x2a15b8(0x1ba)},{'id':'1-1_2','description':_0x2a15b8(0x1c3),'soundASource':'static/TE_sounds/task1.1_sounds/1.1_2a.wav','soundBSource':_0x2a15b8(0x1b6),'spectrumValue':'75','brightnessValue':_0x2a15b8(0x1ce),'articulationValue':'75','envelopeValue':_0x2a15b8(0x1bd),'sliderToMove':'specSlider','correctValue':'150'},{'id':'1-1_3','description':'Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Spectrum\x20dimension.\x20Sound\x20B\x20has\x20a\x20lower\x20Spectrum\x20value.','soundASource':_0x2a15b8(0x1cb),'soundBSource':_0x2a15b8(0x1de),'spectrumValue':_0x2a15b8(0x1dc),'brightnessValue':'57','articulationValue':_0x2a15b8(0x1e7),'envelopeValue':'183','sliderToMove':_0x2a15b8(0x1e6),'correctValue':'50'},{'id':_0x2a15b8(0x1f0),'description':_0x2a15b8(0x1a6),'soundASource':_0x2a15b8(0x1d8),'soundBSource':_0x2a15b8(0x1c8),'spectrumValue':'100','brightnessValue':_0x2a15b8(0x1b3),'articulationValue':_0x2a15b8(0x1a7),'envelopeValue':_0x2a15b8(0x1bc),'sliderToMove':'specSlider','correctValue':'25'},{'id':_0x2a15b8(0x1f9),'description':_0x2a15b8(0x1e5),'soundASource':_0x2a15b8(0x1ab),'soundBSource':_0x2a15b8(0x1fb),'spectrumValue':_0x2a15b8(0x1ac),'brightnessValue':'10','articulationValue':'207','envelopeValue':_0x2a15b8(0x1da),'sliderToMove':_0x2a15b8(0x1c2),'correctValue':'160'},{'id':_0x2a15b8(0x1b4),'description':_0x2a15b8(0x1e5),'soundASource':_0x2a15b8(0x1cf),'soundBSource':_0x2a15b8(0x1f3),'spectrumValue':'121','brightnessValue':_0x2a15b8(0x1c1),'articulationValue':'18','envelopeValue':'68','sliderToMove':_0x2a15b8(0x1c2),'correctValue':_0x2a15b8(0x1ae)},{'id':_0x2a15b8(0x1a8),'description':_0x2a15b8(0x1f7),'soundASource':_0x2a15b8(0x1fc),'soundBSource':_0x2a15b8(0x1d2),'spectrumValue':_0x2a15b8(0x1e8),'brightnessValue':'250','articulationValue':'41','envelopeValue':_0x2a15b8(0x1e1),'sliderToMove':_0x2a15b8(0x1c2),'correctValue':_0x2a15b8(0x1f5)},{'id':_0x2a15b8(0x1d3),'description':_0x2a15b8(0x1f7),'soundASource':'static/TE_sounds/task1.1_sounds/1.1_8a.wav','soundBSource':_0x2a15b8(0x1d1),'spectrumValue':_0x2a15b8(0x1db),'brightnessValue':'125','articulationValue':'73','envelopeValue':'70','sliderToMove':_0x2a15b8(0x1c2),'correctValue':'50'},{'id':_0x2a15b8(0x1df),'description':_0x2a15b8(0x1f4),'soundASource':_0x2a15b8(0x1ef),'soundBSource':_0x2a15b8(0x1c0),'spectrumValue':_0x2a15b8(0x1b3),'brightnessValue':_0x2a15b8(0x1ed),'articulationValue':'25','envelopeValue':'42','sliderToMove':_0x2a15b8(0x1a9),'correctValue':_0x2a15b8(0x1b8)},{'id':_0x2a15b8(0x1c5),'description':_0x2a15b8(0x1f4),'soundASource':_0x2a15b8(0x1d4),'soundBSource':_0x2a15b8(0x1f6),'spectrumValue':'29','brightnessValue':'82','articulationValue':_0x2a15b8(0x1e1),'envelopeValue':'42','sliderToMove':_0x2a15b8(0x1a9),'correctValue':_0x2a15b8(0x1dc)},{'id':_0x2a15b8(0x1b9),'description':'Sounds\x20A\x20and\x20B\x20differ\x20along\x20the\x20Articulation\x20dimension.\x20Sound\x20B\x20has\x20a\x20lower\x20Articulation\x20value.','soundASource':_0x2a15b8(0x1e3),'soundBSource':_0x2a15b8(0x1c6),'spectrumValue':_0x2a15b8(0x1d6),'brightnessValue':'200','articulationValue':_0x2a15b8(0x1fa),'envelopeValue':_0x2a15b8(0x1dc),'sliderToMove':_0x2a15b8(0x1a9),'correctValue':_0x2a15b8(0x1f5)},{'id':_0x2a15b8(0x1e4),'description':_0x2a15b8(0x1b0),'soundASource':_0x2a15b8(0x1e0),'soundBSource':_0x2a15b8(0x1c9),'spectrumValue':'58','brightnessValue':'41','articulationValue':_0x2a15b8(0x1b1),'envelopeValue':_0x2a15b8(0x1ec),'sliderToMove':_0x2a15b8(0x1a9),'correctValue':'75'},{'id':_0x2a15b8(0x1f8),'description':_0x2a15b8(0x1cd),'soundASource':_0x2a15b8(0x1d5),'soundBSource':_0x2a15b8(0x1ca),'spectrumValue':_0x2a15b8(0x1f2),'brightnessValue':'85','articulationValue':'79','envelopeValue':'0','sliderToMove':'enveSlider','correctValue':'150'},{'id':'1-1_14','description':_0x2a15b8(0x1cd),'soundASource':_0x2a15b8(0x1af),'soundBSource':'static/TE_sounds/task1.1_sounds/1.1_14b.wav','spectrumValue':'15','brightnessValue':_0x2a15b8(0x1aa),'articulationValue':'110','envelopeValue':'150','sliderToMove':'enveSlider','correctValue':_0x2a15b8(0x1dd)},{'id':_0x2a15b8(0x1c4),'description':_0x2a15b8(0x1e9),'soundASource':_0x2a15b8(0x1cc),'soundBSource':'static/TE_sounds/task1.1_sounds/1.1_15b.wav','spectrumValue':'221','brightnessValue':'62','articulationValue':'108','envelopeValue':'250','sliderToMove':_0x2a15b8(0x1d0),'correctValue':_0x2a15b8(0x1f5)},{'id':_0x2a15b8(0x1d7),'description':_0x2a15b8(0x1e9),'soundASource':_0x2a15b8(0x1d9),'soundBSource':_0x2a15b8(0x1ee),'spectrumValue':_0x2a15b8(0x1f5),'brightnessValue':'75','articulationValue':'128','envelopeValue':'85','sliderToMove':_0x2a15b8(0x1d0),'correctValue':'10'}];

// Declare variables
const descriptionTrain1 = document.getElementById("descriptionTrain1");
//const answers = Array.from(document.getElementsByClassName("answer-text"));
const trialCounterTextTrain1 = document.getElementById("trialCounterTextTrain1");

let trialCounterTrain1;
const MAX_TRIALS_TRAIN1 = 16;
let acceptingAnswersTrain1;

// Get time of training 1 start
train1Start = Date.now();

let trialSliderToMoveTrain1;
let initialValueTrain1;

startTraining1 = () => {
    trialCounterTrain1 = 0;
    //console.log(descriptionsTrain1);
    acceptingAnswersTrain1 = true;

    availableTrialsTrain1 = getRandomTrialsTrain1(descriptionsTrain1, MAX_TRIALS_TRAIN1);
    //console.log(availableTrialsTrain1);

    getNewTrialTrain1();
}

// Shuffles available trials into a random order
const getRandomTrialsTrain1 = (arr, n) => {
    let len = arr.length;
    if (n > len) {
        throw new RangeError(
            "getRandomTrials: more elements taken than available"
        );
    }

    // Shuffles the order of the trials
    const shuffled = [...arr].sort(() => 0.5 - Math.random());

    // Return randomised array of questions
    return (selected = shuffled.slice(0, n));
}

const getNewTrialTrain1 = () => {
    // End when all trials have been shown
    if (availableTrialsTrain1.length === 0) {
        //console.log("No more trials")
        training1Data = Object.assign({ "overallTrain1": {"timeTrain1": ((Date.now() - train1Start) / 1000)} }, training1Data);
        training1Data = {"training1": training1Data};
        //console.log(training1Data);

        displayModalTrain1();
        return;
    }

    // Increment trial counter and update display
    trialCounterTrain1++;
    trialCounterTextTrain1.innerText = trialCounterTrain1 + "/" + MAX_TRIALS_TRAIN1;

    // Update display with current description
    currentTrialTrain1 = availableTrialsTrain1[0];
    descriptionTrain1.innerText = currentTrialTrain1.description;

    // Update with correct audio files for each trial
    document.getElementById("soundATrain1").setAttribute("src", currentTrialTrain1.soundASource);
    document.getElementById("soundBTrain1").setAttribute("src", currentTrialTrain1.soundBSource);

    //console.log("current trial: " + currentTrialTrain1.spectrumValue, currentTrialTrain1.brightnessValue, currentTrialTrain1.articulationValue, currentTrialTrain1.envelopeValue);
    // Set sliders to starting positions for each trial: values of Sound A
    document.getElementById("specSlider").value = currentTrialTrain1.spectrumValue;
    document.getElementById("brigSlider").value = currentTrialTrain1.brightnessValue;
    document.getElementById("artiSlider").value = currentTrialTrain1.articulationValue;
    document.getElementById("enveSlider").value = currentTrialTrain1.envelopeValue;

    // These setAttributes are necessary to trigger the mutation observers in TimbreXWeb.js
    document.getElementById("specSlider").setAttribute("value", currentTrialTrain1.spectrumValue);
    document.getElementById("brigSlider").setAttribute("value", currentTrialTrain1.brightnessValue);
    document.getElementById("artiSlider").setAttribute("value", currentTrialTrain1.articulationValue);
    document.getElementById("enveSlider").setAttribute("value", currentTrialTrain1.envelopeValue);

    // Get time of trial start
    trialStart = Date.now();

    // Get the initial value of the slider that must be moved
    trialSliderToMoveTrain1 = currentTrialTrain1.sliderToMove;

    if (trialSliderToMoveTrain1 == "specSlider") {
        initialValueTrain1 = currentTrialTrain1.spectrumValue;
    }
    else if (trialSliderToMoveTrain1 == "brigSlider") {
        initialValueTrain1 = currentTrialTrain1.brightnessValue;
    }
    else if (trialSliderToMoveTrain1 == "artiSlider") {
        initialValueTrain1 = currentTrialTrain1.articulationValue;
    }
    else if (trialSliderToMoveTrain1 == "enveSlider") {
        initialValueTrain1 = currentTrialTrain1.envelopeValue;
    }

    //console.log("initial value: ", initialValueTrain1);

    // Add event listeners for answer selection
    let nextCardTrain1 = document.getElementById("nextCardTrain1");  

    nextCardTrain1.addEventListener("click", () => {
        //console.log("current value: ", document.getElementById(trialSliderToMove).value);
         // If not accepting answers, return
        if(!acceptingAnswersTrain1) {
            //console.log("not accepting answers");
            return;
        }
        // Checks if the trial's slider has been moved; if it hasn't, alert user and return
        else if (initialValueTrain1 == document.getElementById(trialSliderToMoveTrain1).value) {
            //console.log("slider must be moved");
            $( "div.warning" ).fadeIn( 300 );
            return;
        }
          
        // Fade out the warning div when slider has been moved
        let warningDivTrain1 = document.getElementById("warningTrain1");
        if (warningDivTrain1.style.display == "block") {
            $( "div.warning" ).fadeOut( 300 );
        } 

        // Set acceptingAnswers to false to prevent double skip
        acceptingAnswersTrain1 = false;

        // Update clicked div with colour for feedback 
        let classToApplyTrain1 = "correct";
            
        // Apply the appropriate class
        nextCardTrain1.classList.add(classToApplyTrain1);

        if (currentTrialTrain1.sliderToMove === "specSlider") {
            trialSlider = "spectrum";
            userValue = document.getElementById("specSlider").value;
        }
        else if (currentTrialTrain1.sliderToMove === "brigSlider") {
            trialSlider = "brightness";
            userValue = document.getElementById("brigSlider").value;
        }
        else if (currentTrialTrain1.sliderToMove === "artiSlider") {
            trialSlider = "articulation";
            userValue = document.getElementById("artiSlider").value;
        }
        else if (currentTrialTrain1.sliderToMove === "enveSlider") {
            trialSlider = "envelope";
            userValue = document.getElementById("enveSlider").value;
        }

        // After time period, remove the correct/incorrect class and get the next question
        setTimeout(() => {
            nextCardTrain1.classList.remove(classToApplyTrain1);

            // Append trial data to object
            // Trial no.: slider; correct value; user's value; accuracy (how close user value is to correct value); 
            training1Data = Object.assign({ [currentTrialTrain1.id]: {"slider": trialSlider, "correctValue": currentTrialTrain1.correctValue, "userValue": userValue, 
                                            "accuracy": (userValue - currentTrialTrain1.correctValue), "time": ((Date.now() - trialStart) / 1000)} }, training1Data);
            //console.log(training1Data);

            getNewTrialTrain1();
            acceptingAnswersTrain1 = true;
        }, 1000);
    });
    availableTrialsTrain1.shift();
};

hideModal = () => {
    const modal = document.getElementById("taskCompleteModal");
    modal.style.display = "none"
}

//Shows task complete modal 
displayModalTrain1 = () => {
    const modal = document.getElementById("taskCompleteModal");
    const modalBody = document.getElementById("modal-body");
    modalBody.innerHTML = /*html*/`
                            <p>
                                In the next task, you will presented with 2 sounds: A and B.<br><br>
                                Listen to both sounds and <strong>identify which Timbre Explorer dimension has changed</strong>, and in <strong>which direction</strong>, to get from sound A to sound B.<br><br>
                                For each pair of sounds you will have <strong>3</strong> attempts to find the correct answer. Click next when you are ready to begin... 
                            </p>
                            <div class="nextButton">
                                <a class="nextText" onclick="hideModal()" href="/testing1" data-link>Next</a>
                            </div>
                        `
    modal.style.display = "block"
}

startTraining1();